/**
 * 
 */
package routing;




import java.util.HashSet;
import java.util.Random;
import java.util.Set;

import movement.MovementModel;

import core.Connection;
import core.DTNHost;
import core.DTNSim;
import core.Message;
import core.Settings;

/**
 * @author khalil
 *
 */
public class FadSink extends ActiveRouter {

	private static Set<String> sinkedMessages=new HashSet<String>();
	private static Set<String> sinkedCodes=new HashSet<String>();

	
	
	/**
	 * @param s
	 */
	public FadSink(Settings s) {
		super(s);
	}

	protected FadSink(FadSink r) {
		super(r);
	}

	static {
		DTNSim.registerForReset(FadSink.class.getCanonicalName());				
		reset();
	}
	
	public void changedConnection(Connection con) {
		return;
	}
			
	
	@Override
	public void update() {
		super.update();
		if (isTransferring() || !canStartTransfer()) {
			return; // transferring, don't try other connections yet
		
		}	
	}
		
	public Message messageTransferred(String id, DTNHost from){
		String[] ids = id.split("+");
		if(ids.length>1)
		{
			sinkedCodes.add(ids[0])
			
		}
		else
		{
			Message m = super.messageTransferred(id, from);
			sinkedMessages.add(m.getId());
			return m;	
		}
	}
	
	protected int checkReceiving(Message m) {
		if(sinkedMessages.contains(m.getId()))
			return DENIED_OLD;
				
		int result = super.checkReceiving(m);
		
		if (result == RCV_OK)
			if (FadSink.insert(m))
				return result;
			else
				return DENIED_OLD;
		return result;
	}
	
	public static synchronized boolean insert(Message m){
		if (sinkedMessages.contains(m.getId()))
			return false;
		sinkedMessages.add(m.getId());	
		return true;
	}
	
	public Set<String> getSinkedMessages() {
		return sinkedMessages;
	}
	
	public static void reset() {
		sinkedMessages.clear();
	}
	
	public String hello(){
		return "FadSink";
	}
	
	@Override
	public MessageRouter replicate() {
		return new FadSink(this);
	}

}



